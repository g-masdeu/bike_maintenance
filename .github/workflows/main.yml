- name: ðŸš€ Desplegar con Docker
  env:
    APP_KEY: ${{ secrets.APP_KEY }}
    APP_URL: ${{ secrets.APP_URL }}
    DB_HOST: ${{ secrets.DB_HOST }}
    DB_PORT: ${{ secrets.DB_PORT }}
    DB_DATABASE: ${{ secrets.DB_DATABASE }}
    DB_USERNAME: ${{ secrets.DB_USERNAME }}
    DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
    GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  run: |
    cd /var/www/bike_maintenance

    # Crear .env de producciÃ³n sin espacios iniciales
    cat > .env <<EOL
APP_NAME=Bike_Maintenance
APP_ENV=production
APP_KEY=$APP_KEY
APP_DEBUG=false
APP_URL=$APP_URL

APP_LOCALE=es
APP_FALLBACK_LOCALE=es
APP_FAKER_LOCALE=es_ES  

PHP_CLI_SERVER_WORKERS=4
BCRYPT_ROUNDS=12

DB_CONNECTION=mysql
DB_HOST=$DB_HOST
DB_PORT=$DB_PORT
DB_DATABASE=$DB_DATABASE
DB_USERNAME=$DB_USERNAME
DB_PASSWORD=$DB_PASSWORD

SESSION_DRIVER=database
CACHE_STORE=database

GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
GOOGLE_REDIRECT=$APP_URL/oauth/google/callback
EOL

    # Detener contenedores antiguos, levantar con build
    docker compose down
    docker compose up -d --build

    # Ejecutar migraciones y cachear dentro del contenedor PHP
    docker compose exec -T app php artisan migrate --force
    docker compose exec -T app php artisan cache:clear
    docker compose exec -T app php artisan config:cache
    docker compose exec -T app php artisan route:cache
    docker compose exec -T app php artisan view:cache
    docker compose exec -T app php artisan event:cache
