name: Laravel CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: bike_maintenance
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: bike_maintenance
      DB_USERNAME: root
      DB_PASSWORD: root

    steps:
      - name: â¬‡ï¸ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: imagick, mbstring, pdo_mysql, bcmath, fileinfo, gd, ext-ctype, xml
          coverage: none

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¥ Instalar dependencias de Node
        run: npm ci

      - name: ðŸ—ï¸ Construir assets con Vite
        run: npm run build --if-present

      - name: ðŸ“¦ Instalar dependencias de Composer
        run: composer install --prefer-dist --no-progress

      - name: ðŸ“„ Configurar entorno de testing (.env)
        run: cp .env.example .env

      - name: ðŸ”‘ Generar APP_KEY
        run: php artisan key:generate

      - name: ðŸ”„ Ejecutar Migraciones
        run: php artisan migrate --force

      - name: ðŸ§ª Ejecutar pruebas
        run: php artisan test --ci

  deploy:
    runs-on: self-hosted
    needs: laravel-tests
    if: github.ref == 'refs/heads/main'

    steps:
      - name: â¬‡ï¸ Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸš€ Desplegar con Docker
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_URL: ${{ secrets.APP_URL }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          cd /var/www/bike_maintenance

          # Crear .env de producciÃ³n sin espacios iniciales
          cat > .env <<EOL 
          APP_NAME=Bike_Maintenance
          APP_ENV=production
          APP_KEY=$APP_KEY
          APP_DEBUG=false
          APP_URL=$APP_URL

          APP_LOCALE=es
          APP_FALLBACK_LOCALE=es
          APP_FAKER_LOCALE=es_ES  

          PHP_CLI_SERVER_WORKERS=4
          BCRYPT_ROUNDS=12

          DB_CONNECTION=mysql
          DB_HOST=$DB_HOST
          DB_PORT=$DB_PORT
          DB_DATABASE=$DB_DATABASE
          DB_USERNAME=$DB_USERNAME
          DB_PASSWORD=$DB_PASSWORD

          SESSION_DRIVER=database
          CACHE_STORE=database

          GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
          GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
          GOOGLE_REDIRECT=$APP_URL/oauth/google/callback
          EOL

          # Detener contenedores antiguos, levantar con build
          docker compose down
          docker compose up -d --build

          # Ejecutar migraciones y cachear dentro del contenedor PHP
          docker compose exec -T app php artisan migrate --force
          docker compose exec -T app php artisan cache:clear
          docker compose exec -T app php artisan config:cache
          docker compose exec -T app php artisan route:cache
          docker compose exec -T app php artisan view:cache
          docker compose exec -T app php artisan event:cache
