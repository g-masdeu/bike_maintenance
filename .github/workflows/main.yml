name: Laravel CI/CD

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: bike_maintenance
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: bike_maintenance
      DB_USERNAME: root
      DB_PASSWORD: root

    steps:
      - name: â¬‡ï¸ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: imagick, mbstring, pdo_mysql, bcmath, fileinfo, gd, ext-ctype, xml
          coverage: none

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¥ Instalar dependencias de Node
        run: npm ci

      - name: ðŸ—ï¸ Construir assets con Vite
        run: npm run build --if-present

      - name: ðŸ“¦ Instalar dependencias de Composer
        run: composer install --prefer-dist --no-progress

      - name: ðŸ“„ Configurar entorno de testing (.env)
        run: cp .env.example .env

      - name: ðŸ”‘ Generar APP_KEY
        run: php artisan key:generate

      - name: ðŸ”„ Ejecutar Migraciones
        run: php artisan migrate --force

      - name: ðŸ§ª Ejecutar pruebas
        run: php artisan test --ci

  deploy:
    runs-on: self-hosted
    needs: laravel-tests
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ³ Detener contenedores anteriores
        run: docker compose down -v || true

      - name: ðŸ§¹ Limpiar directorio y restaurar propiedad
        run: |
          sudo chown -R $(whoami):$(whoami) ${{ github.workspace }} || true
          rm -rf ${{ github.workspace }}/* || true

      - name: â¬‡ï¸ Descargar cÃ³digo
        uses: actions/checkout@v4
        with:
          clean: false

      - name: ðŸš€ Desplegar con Docker
        env:
          # Variables generales
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_URL: ${{ secrets.APP_URL }}
          # Base de datos
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          # Correo (NUEVO)
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        run: |
          # Exportar variables explÃ­citamente por seguridad en el shell
          export APP_KEY="$APP_KEY"
          export APP_URL="$APP_URL"
          export DB_PORT="$DB_PORT"
          export DB_DATABASE="$DB_DATABASE"
          export DB_USERNAME="$DB_USERNAME"
          export DB_PASSWORD="$DB_PASSWORD"
          export MAIL_USERNAME="$MAIL_USERNAME"
          export MAIL_PASSWORD="$MAIL_PASSWORD"
          
          # Crear carpeta nginx si no existe
          mkdir -p nginx

          # Crear configuraciÃ³n Nginx
          cat > nginx/default.conf <<EOL
          server {
            listen 80;
            server_name _;
            root /var/www/html/public;
            index index.php;
            location / {
              try_files \$uri \$uri/ /index.php?\$is_args\$query_string;
            }
            location ~ \.php$ {
              fastcgi_pass app:9000;
              fastcgi_index index.php;
              fastcgi_param SCRIPT_FILENAME "\$realpath_root\$fastcgi_script_name";
              include fastcgi_params;
            }
          }
          EOL

          # ---------------------------------------------------------
          # GENERAR .ENV DE PRODUCCIÃ“N (Con configuraciÃ³n de correo)
          # ---------------------------------------------------------
          cat > .env <<EOL
          APP_NAME=Bike_Maintenance
          APP_ENV=production
          APP_KEY=${APP_KEY}
          APP_DEBUG=false
          APP_URL=${APP_URL}
          
          APP_LOCALE=es
          APP_FALLBACK_LOCALE=es
          APP_FAKER_LOCALE=es_ES
          
          PHP_CLI_SERVER_WORKERS=4
          BCRYPT_ROUNDS=12
          
          LOG_CHANNEL=stack
          LOG_LEVEL=error
          
          DB_CONNECTION=mysql
          DB_HOST=mysql
          DB_PORT=3306
          DB_DATABASE=${DB_DATABASE}
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}
          
          SESSION_DRIVER=database
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null
          
          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          
          # IMPORTANTE: Sync para enviar correos al instante sin worker
          QUEUE_CONNECTION=sync
          
          CACHE_STORE=database
          
          # CONFIGURACIÃ“N DE CORREO GMAIL
          MAIL_MAILER=smtp
          MAIL_HOST=smtp.gmail.com
          MAIL_PORT=587
          MAIL_USERNAME=${MAIL_USERNAME}
          MAIL_PASSWORD=${MAIL_PASSWORD}
          MAIL_ENCRYPTION=tls
          MAIL_FROM_ADDRESS="${MAIL_USERNAME}"
          MAIL_FROM_NAME="Bike Maintenance"
          
          VITE_APP_NAME="Bike Maintenance"
          EOL

          # Levantar Docker
          echo "Levantando contenedores..."
          docker compose down || true
          docker compose up -d --build

          # Esperar a MySQL
          echo "Esperando a que la base de datos estÃ© lista..."
          docker compose exec -T app sh -c '
            max_retries=30; 
            retry_count=0;
            while ! nc -z mysql 3306 && [ $retry_count -lt $max_retries ]; do 
              echo "MySQL no estÃ¡ disponible aÃºn. Esperando 2 segundos..."; 
              sleep 2; 
              retry_count=$((retry_count + 1));
            done
            if [ $retry_count -eq $max_retries ]; then
              echo "Error: MySQL no iniciÃ³ a tiempo."
              exit 1
            fi
            echo "MySQL estÃ¡ listo."
          '
          
          # Permisos
          docker compose exec -T --user root app chmod -R 777 storage bootstrap/cache

          # Comandos finales de Laravel
          # NOTA: Usamos migrate:fresh la primera vez para limpiar tablas viejas de OAuth
          # DespuÃ©s puedes cambiarlo a migrate --force
          docker compose exec -T app php artisan migrate:fresh --force
          
          docker compose exec -T app php artisan cache:clear
          docker compose exec -T app php artisan config:cache
          docker compose exec -T app php artisan route:cache
          docker compose exec -T app php artisan view:cache
          docker compose exec -T app php artisan event:cache
          
          echo "âœ… Despliegue completado."